version: 2
jobs:
  tests:
    docker:
      - image: devbuddy/testing:latest
    working_directory: /go/src/github.com/devbuddy/devbuddy
    steps:
      - checkout
      - run: dep ensure -v -vendor-only
      - run: script/test

  integration-tests:
    docker:
      - image: devbuddy/testing:latest
    working_directory: /go/src/github.com/devbuddy/devbuddy
    steps:
      - checkout
      - run: cat ~/.bashrc
      - run: echo $PATH
      - run: dep ensure -v -vendor-only
      - run: pip install -U pip setuptools && pip install -r tests/requirements.txt
      - run: . ~/.bashrc; echo $PATH; pytest --durations=1 -v tests
      - run: . ~/.bashrc; echo $PATH; pytest --durations=1 --shell zsh -v tests

  lint:
    docker:
      - image: devbuddy/testing:latest
    working_directory: /go/src/github.com/devbuddy/devbuddy
    steps:
      - checkout
      - run: dep ensure -v -vendor-only
      - run: script/lint

  deploy-release:
    docker:
      - image: devbuddy/testing:latest
    working_directory: /go/src/github.com/devbuddy/devbuddy
    steps:
      - checkout
      - run: dep ensure -v -vendor-only
      - run: script/buildall
      - run: ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME `git describe --tags` dist

workflows:
  version: 2
  all:
    jobs:
      - tests:
          filters:
            tags:
              only: /.*/
      - integration-tests:
          filters:
            tags:
              only: /.*/
      - lint:
          filters:
            tags:
              only: /.*/
      - deploy-release:
          requires: [tests, integration-tests, lint]
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
