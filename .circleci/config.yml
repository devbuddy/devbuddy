version: 2
jobs:
  tests: &base_job
    docker:
      - image: circleci/golang:1.10.2
    working_directory: /go/src/github.com/devbuddy/devbuddy
    steps:
      - checkout
      - run: dep ensure
      - run: script/test

  integration-tests-bash:
    <<: *base_job
    steps:
      - checkout
      - run: dep ensure
      - run: &step_install_pyenv
          name: Install PyEnv
          command: |
            DEBIAN_FRONTEND=noninteractive sudo apt-get --no-install-recommends -y install git make build-essential python-dev libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev curl
            git clone git://github.com/yyuu/pyenv.git ~/.pyenv
            echo 'export PYENV_ROOT=$HOME/.pyenv' >> $BASH_ENV
            echo 'export PATH=$PYENV_ROOT/shims:$PYENV_ROOT/bin:$PATH' >> $BASH_ENV
      - run:
          command: script/integration_test "bash"
          environment:
            TERM: dumb

  integration-tests-zsh:
    <<: *base_job
    steps:
      - checkout
      - run: dep ensure
      - run: *step_install_pyenv
      - run:
          name: Install Zsh
          command: |
            DEBIAN_FRONTEND=noninteractive sudo apt-get --no-install-recommends -y install zsh
      - run:
          # shwordsplit needed because old zsh does not support the -u mode
          command: script/integration_test "zsh -o shwordsplit"
          environment:
            TERM: dumb

  lint:
    <<: *base_job
    steps:
      - checkout
      - run: dep ensure
      - run: go get -u gopkg.in/alecthomas/gometalinter.v2
      - run: gometalinter.v2 --install --update
      - run: script/lint

  deploy-release:
    <<: *base_job
    steps:
      - checkout
      - run: dep ensure
      - run: script/buildall
      - run: go get github.com/tcnksm/ghr
      - run: ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME `git describe --tags` dist

workflows:
  version: 2
  all:
    jobs:
      - tests:
          filters:
            tags:
              only: /.*/
      - integration-tests-bash:
          filters:
            tags:
              only: /.*/
      - integration-tests-zsh:
          filters:
            tags:
              only: /.*/
      - lint:
          filters:
            tags:
              only: /.*/
      - deploy-release:
          requires: [tests, integration-tests-bash, integration-tests-zsh, lint]
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v.*/
